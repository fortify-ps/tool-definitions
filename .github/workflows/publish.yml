on:
  workflow_dispatch:
  push:
    branches:
      - main
      
permissions:
  contents: write
  pull-requests: write
      
name: Publish tool definitions
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setup.outputs.matrix }}
    steps:
    - name: Setup
      id: setup
      env:
        CONFIG: >-
          [
             {
                  "tool_name": "fod-uploader",
                  "tool_repo": "fod-dev/fod-uploader-java",
                  "asset_regex": ".*/FodUpload.jar",
                  "add_semver": true
              },
              {
                  "tool_name": "fcli",
                  "tool_repo": "fortify/fcli",
                  "asset_regex": ".*/(fcli-linux.tgz|fcli-mac.tgz|fcli-windows.zip|fcli.jar)",
                  "add_semver": true
              },
              {
                  "tool_name": "bugtracker-utility",
                  "tool_repo": "fortify-ps/FortifyBugTrackerUtility",
                  "asset_regex": ".*/FortifyBugTrackerUtility-.*.zip",
                  "include_semver": false
              },
              {
                  "tool_name": "vuln-exporter",
                  "tool_repo": "fortify/FortifyVulnerabilityExporter",
                  "asset_regex": ".*/FortifyVulnerabilityExporter.zip",
                  "add_semver": true
              },
              {
                  "tool_name": "debricked-cli",
                  "tool_repo": "debricked/cli",
                  "asset_regex": ".*/cli_.*.tar.gz",
                  "add_semver": true
              },
              {
                  "tool_name": "sc-client",
                  "tool_urls": {
                     "23.1.0": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_23.1.0_x64.zip",
                     "22.2.1": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_22.2.1_x64.zip",
                     "22.2.0": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_22.2.0_x64.zip",
                     "22.1.2": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_22.1.2_x64.zip",
                     "22.1.0": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_22.1.0_x64.zip",
                     "21.2.3": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_21.2.3_x64.zip",
                     "21.2.2": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_21.2.2_x64.zip",
                     "22.2.0": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_21.2.0_x64.zip",
                     "21.1.4": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_21.1.4_x64.zip",
                     "21.1.3": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_21.1.3_x64.zip",
                     "21.1.2": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_21.1.2_x64.zip",
                     "20.2.4": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_20.2.4_x64.zip",
                     "20.2.0": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_20.2.0_x64.zip",
                     "20.1.0": "https://tools.fortify.com/scancentral/Fortify_ScanCentral_Client_20.1.0_x64.zip"
                  },
                  "add_semver": false
               }
          ]
      run: echo "matrix=$(jq -r -c . <<< "$CONFIG")" >> $GITHUB_OUTPUT
    - name: Check
      run: jq . <<< '${{ steps.setup.outputs.matrix }}'
      
  generate-tool-definitions:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.setup.outputs.matrix)}}
    steps:
    - uses: actions/checkout@v4
    - run: git pull
    - name: Check
      env:
        MATRIX: ${{ toJSON(matrix) }}
        TOOL_NAME: ${{ fromJSON(toJSON(matrix)).tool_name }}
        TOOL_REPO: ${{ fromJSON(toJSON(matrix)).tool_repo }}
        REGEX: ${{ fromJSON(toJSON(matrix)).regex }} 
      run: |
        echo "MATRIX: $(jq -r -c '.' <<< "$MATRIX")"
        echo "TOOL_NAME: [$TOOL_NAME]"
        echo "TOOL_REPO: [$TOOL_REPO]"
        echo "REGEX: [$REGEX]"
    - name: Generate tool definitions
      uses: ./internal/generator
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        tool_name: ${{ fromJSON(toJSON(matrix)).tool_name }}
        tool_repo: ${{ fromJSON(toJSON(matrix)).tool_repo }}
        tool_urls: ${{ toJSON(fromJSON(toJSON(matrix)).tool_urls) }}
        asset_regex: ${{ fromJSON(toJSON(matrix)).asset_regex }}
        sign_key: ${{ secrets.SIGN_KEY }}
        sign_passphrase: ${{ secrets.SIGN_PASSPHRASE }}
        add_semver: ${{ fromJSON(toJSON(matrix)).add_semver }}
    - name: Configure git
      run: |
        git config user.name github-actions
        git config user.email github-actions@fortify.com
    - name: Commit updates
      run: | 
        git add . && git commit -m "chore: Update ${{ fromJSON(toJSON(matrix)).tool_name }} cache & resources" \
          && git push || \
          echo "No update needed or update failed"
              
        
        
        
        